<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜¤ëŠ˜ ë­ ë¨¹ì§€? ë£°ë › (DB ì—°ë™)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=9ddcc83d3b7ed7f48495e2de9a0a4460&libraries=services"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        .roulette-container {
            position: relative;
            width: 90vw;
            height: 90vw;
            max-width: 450px;
            max-height: 450px;
        }
        canvas {
            width: 100%;
            height: 100%;
            transition: transform 5s cubic-bezier(0.25, 1, 0.5, 1);
        }
        .pointer {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 30px solid #ef4444; /* red-500 */
            z-index: 10;
        }
        .blinking {
            animation: blinker 1s linear infinite;
        }
        @keyframes blinker {
            50% {
                opacity: 0.3;
            }
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <main class="w-full max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-4 gap-6 items-start">
        <!-- í›„ë³´ ëª©ë¡ (ì™¼ìª½) -->
        <div id="restaurant-list-container" class="hidden lg:block order-2 lg:order-1 w-full bg-white p-4 rounded-lg shadow-lg">
            <h2 class="text-xl font-bold text-center mb-4">ì˜¤ëŠ˜ì˜ í›„ë³´</h2>
            <div id="candidate-lists-wrapper" class="space-y-4"></div>
        </div>

        <!-- ë£°ë › (ì¤‘ì•™) -->
        <div class="lg:col-span-2 order-1 lg:order-2 flex flex-col items-center w-full">
            <div class="text-center mb-4">
                <h1 class="text-4xl font-bold text-gray-800">ì˜¤ëŠ˜ ë­ ë¨¹ì§€?</h1>
                <p id="status-message" class="text-gray-600 mt-2 min-h-[1.5rem]">ì£¼ë³€ ë§›ì§‘ì„ ëª¨ìœ¼ëŠ” ì¤‘ì´ì—ìš”...</p>
                <div id="location-fallback" class="hidden mt-2 flex flex-wrap items-center justify-center gap-2 text-sm">
                    <span class="text-gray-500">ìœ„ì¹˜ ì ‘ê·¼ì´ ì–´ë µë‹¤ë©´?</span>
                    <label class="flex items-center gap-2">
                        <span class="text-gray-600">ë™ë„¤ ì„ íƒ</span>
                        <select id="manual-location-select" class="border rounded px-2 py-1 text-sm">
                            <option value="">ë™ë„¤ë¥¼ ê³¨ë¼ì£¼ì„¸ìš”</option>
                            <option value="37.4979,127.0276">ì„œìš¸ ê°•ë‚¨ì—­</option>
                            <option value="37.5575,126.9249">ì„œìš¸ í™ëŒ€ì…êµ¬</option>
                            <option value="37.4021,127.1089">ê²½ê¸° íŒêµ</option>
                            <option value="35.1576,129.0591">ë¶€ì‚° ì„œë©´</option>
                            <option value="35.8714,128.6014">ëŒ€êµ¬ ë™ì„±ë¡œ</option>
                            <option value="35.1796,129.0756">ë¶€ì‚° ë‚¨í¬ë™</option>
                        </select>
                    </label>
                    <button id="apply-manual-location" class="bg-amber-500 hover:bg-amber-600 text-white font-semibold px-3 py-1 rounded-md">ì´ ë™ë„¤ë¡œ ë³´ê¸°</button>
                </div>
            </div>

            <div class="roulette-container mx-auto mb-4">
                <div class="pointer"></div>
                <canvas id="rouletteCanvas"></canvas>
            </div>

            <div id="winner-card" class="hidden w-full max-w-md bg-white rounded-lg shadow-lg mb-4 p-4 space-y-3">
                <div class="flex items-start justify-between">
                    <div>
                        <p class="text-sm font-semibold text-green-600">ì˜¤ëŠ˜ì˜ ë‹¹ì²¨!</p>
                        <h2 id="winner-name" class="text-2xl font-bold text-gray-800"></h2>
                    </div>
                    <span id="winner-tag" class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">í–‰ìš´ ê°€ë“</span>
                </div>
                <div class="space-y-2 text-sm text-gray-600">
                    <p id="winner-address" class="flex items-center gap-2"></p>
                    <p id="winner-phone" class="flex items-center gap-2"></p>
                    <p id="winner-tip" class="flex items-center gap-2 text-xs text-gray-500"></p>
                </div>
                <div class="flex flex-wrap gap-2">
                    <a id="winner-map-btn" class="flex-1 text-center bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 rounded-md" target="_blank" rel="noopener">ê¸¸ì°¾ê¸°</a>
                    <a id="winner-call-btn" class="flex-1 text-center bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-2 rounded-md" target="_blank" rel="noopener">ì „í™”í•˜ê¸°</a>
                </div>
                <button id="winner-reroll" class="w-full bg-gray-900 hover:bg-gray-700 text-white font-bold py-2 rounded-md">ë‹¤ì‹œ ëŒë¦¬ê¸°</button>
            </div>

            <div class="bg-white p-4 rounded-lg shadow-md w-full max-w-md mb-4">
                <div class="flex items-center justify-between mb-4">
                    <label for="mode-select" class="font-semibold text-gray-700 flex items-center gap-2">
                        ë£°ë › ëª¨ë“œ
                        <span class="text-xs bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full">í‰ì /ë¦¬ë·° ê¸°ë°˜ ì¶”ì²œì€ ì¤€ë¹„ ì¤‘</span>
                    </label>
                    <select id="mode-select" class="rounded-md border-gray-300 shadow-sm">
                        <option value="mix" selected>ğŸ± ì¶”ì²œ ë¯¹ìŠ¤</option>
                        <option value="distance">ğŸš¶â€â™‚ï¸ ê°€ê¹Œìš´ ìˆœ 9ê³³</option>
                        <option value="random">ğŸ² ëœë¤ 9ê³³</option>
                    </select>
                </div>
                <div class="flex justify-center space-x-2">
                    <button id="resetBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full shadow-lg">ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                    <button id="startBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-full shadow-lg" disabled>START</button>
                </div>
            </div>
            
            <div id="save-container" class="hidden w-full max-w-md mb-4">
                <div class="bg-white p-3 rounded-lg shadow">
                    <div class="flex justify-center items-center space-x-2">
                        <input type="text" id="roulette-name-input" placeholder="ë£°ë › ì´ë¦„ ì…ë ¥" class="border rounded px-2 py-1 flex-grow">
                        <button id="saveBtn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-1 px-3 rounded-md">ì €ì¥</button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2 text-center">ë§ˆìŒì— ë“œëŠ” ë£°ë ›ì´ ë‚˜ì˜¤ë©´ ì†Œì¥í•´ë‘ê³  ê³„ì† ì‚¬ìš©í•´ë³´ì„¸ìš”!</p>
                </div>
            </div>

            <div class="w-full max-w-md bg-white rounded-lg shadow p-4">
                <h2 class="text-xl font-bold text-center mb-2">ë‚˜ì˜ ë£°ë › ëª©ë¡</h2>
                <div id="saved-roulettes-list" class="h-40 overflow-y-auto custom-scrollbar"></div>
            </div>

            <!-- íŒ€í”Œë ˆì´ ì„¹ì…˜ -->
            <div id="team-card" class="w-full max-w-md bg-white rounded-lg shadow p-4 mt-6">
                <h2 class="text-xl font-bold text-center mb-2">ğŸ¤ íŒ€í”Œë ˆì´</h2>
                <p class="text-xs text-gray-500 text-center mb-3">ê°™ì€ ì—‘ì„¸ìŠ¤ ì½”ë“œë¡œ ì ‘ì†í•˜ë©´ í•˜ë‚˜ì˜ ë£°ë ›ì„ í•¨ê»˜ ì±„ìš¸ ìˆ˜ ìˆì–´ìš”.</p>
                <div class="flex flex-col sm:flex-row gap-2 mb-3">
                    <input id="team-access-input" type="text" placeholder="ì—‘ì„¸ìŠ¤ ì½”ë“œ (ì˜ë¬¸/ìˆ«ì)" class="border rounded px-3 py-2 text-sm flex-1">
                    <button id="team-join-btn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-md">ì°¸ì—¬í•˜ê¸°</button>
                    <button id="team-leave-btn" class="hidden bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-md">ë‚˜ê°€ê¸°</button>
                </div>
                <p id="team-status" class="text-xs text-center text-slate-500 mb-3">ì—‘ì„¸ìŠ¤ ì½”ë“œë¥¼ ì…ë ¥í•˜ë©´ íŒ€ì´ ìƒì„±ë˜ê±°ë‚˜ ì…ì¥ë©ë‹ˆë‹¤.</p>
                <div id="team-slots-container" class="space-y-2 hidden"></div>
            </div>

            <!-- ì§ì ‘ ì°¨íŠ¸ ë§Œë“¤ê¸° ì„¹ì…˜ -->
            <div class="w-full max-w-md bg-white rounded-lg shadow p-4 mt-6">
                <h2 class="text-xl font-bold text-center mb-2">ğŸ“ ì§ì ‘ ì°¨íŠ¸ ë§Œë“¤ê¸°</h2>
                <p class="text-xs text-gray-500 text-center mb-3">9ì¹¸ì„ ëª¨ë‘ ì±„ìš°ì§€ ì•Šì•„ë„ ê´œì°®ì•„ìš”. ë¹ˆì¹¸ì€ ìë™ìœ¼ë¡œ â€˜ë‹¤ì‹œ í•œ ë²ˆâ€™ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤.</p>
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <button class="sample-template-btn bg-slate-200 hover:bg-slate-300 text-gray-700 text-sm font-semibold py-2 rounded" data-template="korean">í•œì‹ ìƒ˜í”Œ</button>
                    <button class="sample-template-btn bg-slate-200 hover:bg-slate-300 text-gray-700 text-sm font-semibold py-2 rounded" data-template="noodle">ë©´ ìš”ë¦¬ ìƒ˜í”Œ</button>
                    <button class="sample-template-btn bg-slate-200 hover:bg-slate-300 text-gray-700 text-sm font-semibold py-2 rounded" data-template="office">ì§ì¥ì¸ ë¹ ë¥¸ ì ì‹¬</button>
                    <button class="sample-template-btn bg-slate-200 hover:bg-slate-300 text-gray-700 text-sm font-semibold py-2 rounded" data-template="snack">ë¶„ì‹ ì¸ê¸° ë©”ë‰´</button>
                </div>
                <div id="custom-chart-inputs" class="grid grid-cols-3 gap-2 mb-3">
                    <input type="text" class="custom-input border rounded px-2 py-1 text-sm" placeholder="í•­ëª© 1">
                    <input type="text" class="custom-input border rounded px-2 py-1 text-sm" placeholder="í•­ëª© 2">
                    <input type="text" class="custom-input border rounded px-2 py-1 text-sm" placeholder="í•­ëª© 3">
                    <input type="text" class="custom-input border rounded px-2 py-1 text-sm" placeholder="í•­ëª© 4">
                    <input type="text" class="custom-input border rounded px-2 py-1 text-sm" placeholder="í•­ëª© 5">
                    <input type="text" class="custom-input border rounded px-2 py-1 text-sm" placeholder="í•­ëª© 6">
                    <input type="text" class="custom-input border rounded px-2 py-1 text-sm" placeholder="í•­ëª© 7">
                    <input type="text" class="custom-input border rounded px-2 py-1 text-sm" placeholder="í•­ëª© 8">
                    <input type="text" class="custom-input border rounded px-2 py-1 text-sm" placeholder="í•­ëª© 9">
                </div>
                <button id="apply-custom-btn" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 rounded-md">ì ìš©í•˜ê¸°</button>
            </div>
        </div>

        <!-- ìë‘í•˜ê¸° ê²Œì‹œíŒ (ì˜¤ë¥¸ìª½) -->
        <div class="order-3 w-full bg-white p-4 rounded-lg shadow-lg">
            <h2 class="text-xl font-bold text-center mb-2">ğŸ‘‘ ë£°ë › ìë‘í•˜ê¸°</h2>
            <p class="text-xs text-gray-500 text-center mb-3">ì¢‹ì•„ìš”ê°€ ë§ì€ ìˆœì„œëŒ€ë¡œ ë³´ì—¬ë“œë ¤ìš”. ì‹«ì–´ìš”ê°€ ë§ì€ ê¸€ì€ ìš´ì˜ìê°€ í™•ì¸ í›„ ìˆ¨ê¹ë‹ˆë‹¤.</p>
            <input type="search" id="search-shared" placeholder="ì˜ˆ: (ì—­ì‚¼) ì¡±ë°œ" class="w-full p-2 border rounded-md mb-4">
            <div id="shared-roulettes-list" class="h-[430px] overflow-y-auto custom-scrollbar"></div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, getDoc, setDoc, deleteDoc, query, orderBy, serverTimestamp, updateDoc, increment, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- UI ìš”ì†Œ ---
        const canvas = document.getElementById('rouletteCanvas');
        const ctx = canvas.getContext('2d');
        const resetBtn = document.getElementById('resetBtn');
        const startBtn = document.getElementById('startBtn');
        const saveBtn = document.getElementById('saveBtn');
        const statusMessage = document.getElementById('status-message');
        const saveContainer = document.getElementById('save-container');
        const rouletteNameInput = document.getElementById('roulette-name-input');
        const savedRoulettesList = document.getElementById('saved-roulettes-list');
        const restaurantListContainer = document.getElementById('restaurant-list-container');
        const candidateListsWrapper = document.getElementById('candidate-lists-wrapper');
        const modeSelect = document.getElementById('mode-select');
        const sharedRoulettesList = document.getElementById('shared-roulettes-list');
        const searchSharedInput = document.getElementById('search-shared');
        const applyCustomBtn = document.getElementById('apply-custom-btn');
        const locationFallback = document.getElementById('location-fallback');
        const manualLocationSelect = document.getElementById('manual-location-select');
        const applyManualLocationBtn = document.getElementById('apply-manual-location');
        const winnerCard = document.getElementById('winner-card');
        const winnerName = document.getElementById('winner-name');
        const winnerAddress = document.getElementById('winner-address');
        const winnerPhone = document.getElementById('winner-phone');
        const winnerTip = document.getElementById('winner-tip');
        const winnerMapBtn = document.getElementById('winner-map-btn');
        const winnerCallBtn = document.getElementById('winner-call-btn');
        const winnerRerollBtn = document.getElementById('winner-reroll');
        const winnerTag = document.getElementById('winner-tag');
        const teamAccessInput = document.getElementById('team-access-input');
        const teamJoinBtn = document.getElementById('team-join-btn');
        const teamLeaveBtn = document.getElementById('team-leave-btn');
        const teamStatus = document.getElementById('team-status');
        const teamSlotsContainer = document.getElementById('team-slots-container');
        
        // --- ì „ì—­ ë³€ìˆ˜ ---
        const SEGMENT_COUNT = 9;
        const colors = ['#fde68a', '#dcfce7', '#dbeafe', '#f3e8ff', '#fee2e2', '#fef3c7', '#e0f2fe', '#fce7f3', '#e5e7eb'];
        let restaurants = [];
        let isSpinning = false;
        let winnerIndex = -1;
        let blinkAnimationId;
        let db, auth, userId;
        let lastKnownCoords = null;
        let allSharedRoulettes = [];
        let teamMode = false;
        let teamCode = '';
        let teamDocRef = null;
        let teamUnsubscribe = null;
        let teamSlots = Array.from({ length: SEGMENT_COUNT }, () => '');
        let lastTeamSpinTrigger = '';
        let teamSnapshotInitialized = false;
        
        // --- ì´ˆê¸°í™” ---
        window.onload = () => {
            const size = Math.min(window.innerWidth * 0.9, 450);
            canvas.width = size;
            canvas.height = size;
            drawWheel();
            initializeFirebase();
            attemptAutoDiscovery();
        };

        function attemptAutoDiscovery() {
            statusMessage.textContent = 'ì£¼ë³€ ë§›ì§‘ì„ ëª¨ìœ¼ëŠ” ì¤‘ì´ì—ìš”...';
            handleReset({ silent: true });
        }

        const textEscapes = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
        function safeText(text = '') {
            return String(text).replace(/[&<>"']/g, char => textEscapes[char] || char);
        }

        function updateStartButtonState() {
            if (teamMode) {
                const allFilled = teamSlots.every(slot => typeof slot === 'string' && slot.trim() !== '');
                startBtn.disabled = isSpinning || !allFilled;
                resetBtn.disabled = isSpinning;
            } else {
                startBtn.disabled = isSpinning || restaurants.length < SEGMENT_COUNT;
                resetBtn.disabled = isSpinning;
            }
        }

        function sanitizeAccessCode(raw = '') {
            return raw.replace(/[^a-zA-Z0-9]/g, '').toUpperCase().slice(0, 12);
        }

        async function initializeFirebase() {
            try {
                const firebaseConfig = {
                  apiKey: "AIzaSyCULXkDYqAfCtpN7PmQktYachfyB7P8dqk",
                  authDomain: "lunch-78f47.firebaseapp.com",
                  projectId: "lunch-78f47",
                  storageBucket: "lunch-78f47.appspot.com",
                  messagingSenderId: "612330931668",
                  appId: "1:612330931668:web:07ab3d8ac7bba96f5ac241"
                };

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        loadSavedRoulettes();
                        loadSharedRoulettes();
                        resetBtn.disabled = false;
                    } else {
                        signInAnonymously(auth).catch(error => console.error("Anonymous sign-in failed:", error));
                    }
                });
            } catch (error) {
                console.error("Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:", error);
                statusMessage.textContent = "ì•± ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
            }
        }

        function updateTeamUIState() {
            if (teamMode) {
                teamJoinBtn.classList.add('hidden');
                teamLeaveBtn.classList.remove('hidden');
                teamSlotsContainer.classList.remove('hidden');
                teamAccessInput.value = teamCode;
            } else {
                teamJoinBtn.classList.remove('hidden');
                teamLeaveBtn.classList.add('hidden');
                teamSlotsContainer.classList.add('hidden');
                teamAccessInput.value = '';
                teamStatus.textContent = 'ì—‘ì„¸ìŠ¤ ì½”ë“œë¥¼ ì…ë ¥í•˜ë©´ íŒ€ì´ ìƒì„±ë˜ê±°ë‚˜ ì…ì¥ë©ë‹ˆë‹¤.';
            }
        }

        function createTeamEntry(index, text) {
            const raw = typeof text === 'string' ? text : '';
            const display = raw.trim() === '' ? `ì¹¸ ${index + 1}` : raw;
            return {
                id: `team-${index}`,
                place_name: display,
                rawText: raw,
                place_url: '#',
                address_name: '',
                road_address_name: '',
                phone: '',
                distance: 0,
                isTeamEntry: true
            };
        }

        function updateTeamSlotsUI(slots = []) {
            if (!teamMode) return;
            teamSlotsContainer.innerHTML = '';
            slots.forEach((slot, index) => {
                const row = document.createElement('div');
                row.className = 'flex items-center gap-2';

                const label = document.createElement('span');
                label.className = 'w-6 text-xs font-semibold text-slate-500 text-right';
                label.textContent = `${index + 1}.`;

                const input = document.createElement('input');
                input.className = 'team-slot-input border rounded px-2 py-1 text-sm flex-1';
                input.value = slot || '';
                input.setAttribute('data-index', index);

                const button = document.createElement('button');
                button.className = 'team-slot-save bg-indigo-500 hover:bg-indigo-600 text-white text-xs font-semibold px-3 py-1 rounded-md flex-shrink-0';
                button.textContent = 'ì €ì¥';

                button.addEventListener('click', () => saveTeamSlot(index, input.value));
                input.addEventListener('keyup', (event) => {
                    if (event.key === 'Enter') {
                        saveTeamSlot(index, input.value);
                    }
                });

                row.appendChild(label);
                row.appendChild(input);
                row.appendChild(button);
                teamSlotsContainer.appendChild(row);
            });
        }

        function applyTeamSlotsToRestaurants(slots = []) {
            if (!teamMode) return;
            teamSlots = Array.from({ length: SEGMENT_COUNT }, (_, idx) => (slots[idx] || ''));
            restaurants = teamSlots.map((slot, index) => createTeamEntry(index, slot));
            candidateListsWrapper.innerHTML = '';
            restaurantListContainer.classList.add('hidden');
            saveContainer.classList.add('hidden');
            drawWheel();
            updateTeamSlotsUI(teamSlots);

            const filledCount = teamSlots.filter(slot => slot.trim() !== '').length;
            if (filledCount === SEGMENT_COUNT) {
                teamStatus.textContent = 'ëª¨ë“  ì¹¸ì´ ì±„ì›Œì¡Œì–´ìš”! ì´ì œ START ë²„íŠ¼ìœ¼ë¡œ í•¨ê»˜ ëŒë ¤ë³´ì„¸ìš”.';
                if (winnerIndex === -1 && !isSpinning) {
                    statusMessage.textContent = 'íŒ€ ë£°ë ›ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤! START ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ëª¨ë‘ê°€ ë™ì‹œì— ë³¼ ìˆ˜ ìˆì–´ìš”.';
                }
            } else {
                teamStatus.textContent = `${filledCount}/${SEGMENT_COUNT}ì¹¸ ì±„ì›Œì¡Œì–´ìš”. ëª¨ë‘ ì±„ìš°ë©´ START ë²„íŠ¼ì´ í™œì„±í™”ë©ë‹ˆë‹¤.`;
                if (winnerIndex === -1 && !isSpinning) {
                    statusMessage.textContent = 'íŒ€ ë£°ë ›ì„ ì±„ìš°ëŠ” ì¤‘ì´ì—ìš”. íŒ€ì›ë“¤ê³¼ í•¨ê»˜ ê° ì¹¸ì„ ì‘ì„±í•´ ì£¼ì„¸ìš”.';
                }
            }
            updateStartButtonState();
        }

        async function saveTeamSlot(index, value) {
            if (!teamMode || !teamDocRef) return;
            const trimmed = (value || '').trim();
            try {
                await updateDoc(teamDocRef, {
                    [`slots.${index}`]: trimmed,
                    updatedAt: serverTimestamp(),
                    lastUpdatedBy: userId || null
                });
            } catch (error) {
                console.error('íŒ€ ìŠ¬ë¡¯ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
                statusMessage.textContent = 'ìŠ¬ë¡¯ì„ ì €ì¥í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
            }
        }

        async function clearTeamSlots() {
            if (!teamMode || !teamDocRef) return;
            try {
                await setDoc(teamDocRef, {
                    slots: Array.from({ length: SEGMENT_COUNT }, () => '')
                }, { merge: true });
                winnerIndex = -1;
                canvas.classList.remove('blinking');
                drawWheel();
                statusMessage.textContent = 'íŒ€ ë£°ë ›ì„ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë‚´ìš©ì„ ì±„ì›Œì£¼ì„¸ìš”.';
            } catch (error) {
                console.error('íŒ€ ë£°ë › ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                statusMessage.textContent = 'íŒ€ ë£°ë › ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
            }
        }

        async function joinTeamRoom() {
            if (!db) {
                statusMessage.textContent = 'ì•±ì´ ì¤€ë¹„ë˜ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
                return;
            }
            const sanitized = sanitizeAccessCode(teamAccessInput.value.trim());
            if (!sanitized) {
                teamStatus.textContent = 'ì˜ë¬¸ê³¼ ìˆ«ìë¡œ ì´ë£¨ì–´ì§„ ì—‘ì„¸ìŠ¤ ì½”ë“œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.';
                teamAccessInput.focus();
                return;
            }
            if (teamMode && sanitized === teamCode) {
                teamStatus.textContent = `ì´ë¯¸ '${teamCode}' íŒ€ì— ì°¸ì—¬ ì¤‘ì…ë‹ˆë‹¤.`;
                return;
            }

            teamJoinBtn.disabled = true;
            teamJoinBtn.classList.add('opacity-60', 'cursor-not-allowed');
            try {
                await enterTeamMode(sanitized);
            } catch (error) {
                console.error('íŒ€í”Œë ˆì´ ì…ì¥ ì‹¤íŒ¨:', error);
                statusMessage.textContent = 'íŒ€ì— ì°¸ì—¬í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
            } finally {
                teamJoinBtn.disabled = false;
                teamJoinBtn.classList.remove('opacity-60', 'cursor-not-allowed');
            }
        }

        async function enterTeamMode(code) {
            if (!db) return;
            if (teamUnsubscribe) {
                teamUnsubscribe();
                teamUnsubscribe = null;
            }

            resetState(true);
            canvas.classList.remove('blinking');
            winnerIndex = -1;

            teamMode = true;
            teamCode = code;
            teamAccessInput.value = code;
            updateTeamUIState();

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            teamDocRef = doc(db, "artifacts", appId, "team-rooms", code);

            try {
                const docSnap = await getDoc(teamDocRef);
                if (!docSnap.exists()) {
                    await setDoc(teamDocRef, {
                        slots: Array.from({ length: SEGMENT_COUNT }, () => ''),
                        createdAt: serverTimestamp()
                    });
                }
            } catch (error) {
                console.error('íŒ€ ë¬¸ì„œ ì¤€ë¹„ ì‹¤íŒ¨:', error);
                teamMode = false;
                teamDocRef = null;
                updateTeamUIState();
                throw error;
            }

            lastTeamSpinTrigger = '';
            teamSnapshotInitialized = false;
            teamUnsubscribe = onSnapshot(teamDocRef, handleTeamSnapshot);
            statusMessage.textContent = `íŒ€ ë£°ë › '${code}'ì— ì°¸ì—¬í–ˆì–´ìš”. ê° ì¹¸ì„ ì±„ì›Œì£¼ì„¸ìš”.`;
        }

        function handleTeamSnapshot(docSnap) {
            if (!docSnap.exists()) return;
            const data = docSnap.data() || {};
            const slots = Array.isArray(data.slots) ? data.slots : [];
            applyTeamSlotsToRestaurants(slots);

            if (data.spin && data.spin.triggerId) {
                if (!teamSnapshotInitialized) {
                    lastTeamSpinTrigger = data.spin.triggerId;
                } else if (data.spin.triggerId !== lastTeamSpinTrigger) {
                    lastTeamSpinTrigger = data.spin.triggerId;
                    triggerTeamSpinFromSnapshot(data.spin);
                }
            }
            teamSnapshotInitialized = true;
        }

        function triggerTeamSpinFromSnapshot(spinState = {}) {
            const rotation = Number(spinState.totalRotation) || 0;
            const targetIndex = typeof spinState.winnerIndex === 'number'
                ? spinState.winnerIndex
                : calculateWinnerIndex(rotation);
            animateSpin(rotation, targetIndex, { triggeredByTeam: true });
        }

        function leaveTeamMode() {
            if (teamUnsubscribe) {
                teamUnsubscribe();
                teamUnsubscribe = null;
            }
            teamMode = false;
            teamCode = '';
            teamDocRef = null;
            teamSlots = Array.from({ length: SEGMENT_COUNT }, () => '');
            lastTeamSpinTrigger = '';
            teamSnapshotInitialized = false;
            winnerIndex = -1;
            canvas.classList.remove('blinking');
            updateTeamUIState();
            resetState();
            attemptAutoDiscovery();
            statusMessage.textContent = 'íŒ€í”Œë ˆì´ ëª¨ë“œì—ì„œ ë‚˜ì™”ì–´ìš”. ì£¼ë³€ ë§›ì§‘ì„ ë‹¤ì‹œ ì°¾ëŠ” ì¤‘ì…ë‹ˆë‹¤.';
        }

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
        resetBtn.addEventListener('click', () => handleReset());
        startBtn.addEventListener('click', handleStart);
        saveBtn.addEventListener('click', handleSave);
        searchSharedInput.addEventListener('input', renderSharedRoulettes);
        applyCustomBtn.addEventListener('click', handleApplyCustomChart);
        teamJoinBtn.addEventListener('click', joinTeamRoom);
        teamLeaveBtn.addEventListener('click', () => leaveTeamMode());
        teamAccessInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                joinTeamRoom();
            }
        });
        applyManualLocationBtn.addEventListener('click', () => {
            if (teamMode) {
                statusMessage.textContent = 'íŒ€í”Œë ˆì´ ëª¨ë“œì—ì„œëŠ” ì£¼ë³€ ì‹ë‹¹ ë¶ˆëŸ¬ì˜¤ê¸°ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ì–´ìš”.';
                return;
            }
            const value = manualLocationSelect.value;
            if (!value) {
                statusMessage.textContent = 'ë™ë„¤ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.';
                return;
            }
            const [lat, lng] = value.split(',').map(Number);
            locationFallback.classList.add('hidden');
            fetchRestaurants(lat, lng, 'manual');
        });
        winnerRerollBtn.addEventListener('click', () => {
            if (!startBtn.disabled) {
                handleStart();
            }
        });

        document.querySelectorAll('.sample-template-btn').forEach(btn => {
            btn.addEventListener('click', () => applyTemplate(btn.dataset.template));
        });
        
        // --- ë Œë”ë§ í•¨ìˆ˜ ---
        function drawWheel() {
            const radius = canvas.width / 2;
            const segmentAngle = (2 * Math.PI) / SEGMENT_COUNT;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.translate(radius, radius);

            for (let i = 0; i < SEGMENT_COUNT; i++) {
                ctx.beginPath();
                ctx.moveTo(0, 0);
                const startAngle = segmentAngle * i - segmentAngle / 2;
                const endAngle = segmentAngle * (i + 1) - segmentAngle / 2;
                ctx.arc(0, 0, radius - 5, startAngle, endAngle);
                ctx.closePath();
                
                if (winnerIndex === i && canvas.classList.contains('blinking')) {
                     ctx.fillStyle = i % 2 === 0 ? '#fca5a5' : '#f87171';
                } else {
                    ctx.fillStyle = colors[i % colors.length];
                }
                ctx.fill();
                
                ctx.save();
                ctx.rotate(startAngle + segmentAngle / 2);
                ctx.textAlign = 'right';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = '#1f2937';
                ctx.font = `bold ${radius * 0.08}px 'Noto Sans KR'`;
                
                const text = restaurants[i] ? restaurants[i].place_name : (restaurants.length > 0 ? '?' : 'ì¤€ë¹„ ì¤‘');
                const textRadius = radius * 0.9;
                
                let displayText = text;
                if (ctx.measureText(text).width > radius * 0.7) {
                    displayText = text.substring(0, 7) + '...';
                }

                ctx.fillText(displayText, textRadius, 0);
                ctx.restore();
            }
            ctx.restore();
        }

        // --- ìƒíƒœ ê´€ë¦¬ í•¨ìˆ˜ ---
        function handleReset(options = {}) {
            if (isSpinning) return;
            if (teamMode) {
                resetBtn.disabled = true;
                clearTeamSlots().finally(() => updateStartButtonState());
                return;
            }
            const { silent = false } = options;
            resetState(silent);
            if (!silent) {
                statusMessage.textContent = 'ì£¼ë³€ ì‹ë‹¹ì„ ë‹¤ì‹œ ì°¾ê³  ìˆì–´ìš”...';
            }
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(onGeoSuccess, onGeoError, { enableHighAccuracy: false, timeout: 8000 });
            } else {
                statusMessage.textContent = 'ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë™ë„¤ë¥¼ ì§ì ‘ ì„ íƒí•´ ì£¼ì„¸ìš”.';
                resetBtn.disabled = false;
                locationFallback.classList.remove('hidden');
            }
        }

        function resetState(keepStatus = false) {
            isSpinning = false;
            startBtn.disabled = true;
            resetBtn.disabled = true;
            saveContainer.classList.add('hidden');
            restaurantListContainer.classList.add('hidden');
            restaurants = [];
            winnerIndex = -1;
            canvas.style.transition = 'none';
            canvas.style.transform = `rotate(0deg)`;
            canvas.classList.remove('blinking');
            if (blinkAnimationId) cancelAnimationFrame(blinkAnimationId);
            drawWheel();
            winnerCard.classList.add('hidden');
            if (!keepStatus) {
                statusMessage.textContent = 'ì£¼ë³€ ë§›ì§‘ì„ ëª¨ìœ¼ëŠ” ì¤‘ì´ì—ìš”...';
            }
            updateStartButtonState();
        }

        function calculateWinnerIndex(totalRotation) {
            const normalized = ((totalRotation % 360) + 360) % 360;
            const segmentAngle = 360 / SEGMENT_COUNT;
            const winningAngle = (270 - normalized + 360) % 360;
            return Math.round(winningAngle / segmentAngle) % SEGMENT_COUNT;
        }

        function animateSpin(totalRotation, forcedIndex = null) {
            isSpinning = true;
            saveContainer.classList.add('hidden');
            canvas.classList.remove('blinking');
            if (blinkAnimationId) cancelAnimationFrame(blinkAnimationId);
            winnerCard.classList.add('hidden');
            updateStartButtonState();

            canvas.style.transition = 'transform 5s cubic-bezier(0.1, 0.7, 0.3, 1)';
            canvas.style.transform = `rotate(${totalRotation}deg)`;

            setTimeout(() => {
                isSpinning = false;
                const targetIndex = typeof forcedIndex === 'number' ? forcedIndex : calculateWinnerIndex(totalRotation);
                winnerIndex = targetIndex;
                const winner = restaurants[winnerIndex];
                updateStartButtonState();

                if (!winner || (winner.isTeamEntry && (winner.rawText || '').trim() === '')) {
                    statusMessage.textContent = 'ì•„ì§ ë¹„ì–´ ìˆëŠ” ì¹¸ì— ë©ˆì·„ì–´ìš”. ë‚´ìš©ì„ ì±„ì›Œë³¼ê¹Œìš”?';
                    winnerCard.classList.add('hidden');
                    startBlinking();
                    return;
                }

                if (!teamMode && winner.id === 'reroll') {
                    statusMessage.innerHTML = `ì•„ì‰½ë„¤ìš”! <span class="font-bold text-red-600">ë‹¤ì‹œ í•œ ë²ˆ!</span>`;
                    winnerCard.classList.add('hidden');
                    startBlinking();
                    return;
                }

                if (teamMode && winner.isTeamEntry) {
                    const displayName = safeText((winner.rawText || winner.place_name));
                    statusMessage.innerHTML = `íŒ€ ë£°ë › ê²°ê³¼ëŠ” <span class="font-bold text-emerald-600">${displayName}</span>!`;
                } else {
                    statusMessage.innerHTML = `ì˜¤ëŠ˜ì˜ ì‹ì‚¬ëŠ” <a href="${winner.place_url || '#'}" target="_blank" class="font-bold text-blue-600 underline">${safeText(winner.place_name)}</a>!`;
                }

                populateWinnerCard(winner);
                winnerCard.classList.remove('hidden');         
                startBlinking();
            }, 5000);
        }

        function handleStart() {
            if (isSpinning) return;

            if (teamMode) {
                if (!teamDocRef) {
                    statusMessage.textContent = 'íŒ€ ì •ë³´ê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
                    return;
                }
                const allFilled = teamSlots.every(slot => slot.trim() !== '');
                if (!allFilled) {
                    statusMessage.textContent = 'ëª¨ë“  ì¹¸ì„ ì±„ì›Œì•¼ ë£°ë ›ì„ ëŒë¦´ ìˆ˜ ìˆì–´ìš”!';
                    return;
                }
                if (blinkAnimationId) cancelAnimationFrame(blinkAnimationId);
                canvas.classList.remove('blinking');
                winnerCard.classList.add('hidden');
                isSpinning = true;
                updateStartButtonState();
                const randomSpins = Math.floor(Math.random() * 5) + 5;
                const randomStopAngle = Math.random() * 360;
                const totalRotation = randomSpins * 360 + randomStopAngle;
                const winnerIdx = calculateWinnerIndex(totalRotation);
                const spinPayload = {
                    triggerId: `${userId || 'guest'}-${Date.now()}`,
                    totalRotation,
                    winnerIndex: winnerIdx,
                    initiatedAt: Date.now(),
                    initiator: userId || null
                };
                updateDoc(teamDocRef, { spin: spinPayload }).catch(error => {
                    console.error('íŒ€ ë£°ë › íšŒì „ ì •ë³´ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
                    statusMessage.textContent = 'ë£°ë ›ì„ ëŒë¦¬ì§€ ëª»í–ˆì–´ìš”. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
                    isSpinning = false;
                    updateStartButtonState();
                });
                return;
            }

            if (restaurants.length < SEGMENT_COUNT) return;

            const randomSpins = Math.floor(Math.random() * 5) + 5;
            const randomStopAngle = Math.random() * 360;
            const totalRotation = randomSpins * 360 + randomStopAngle;
            const winnerIdx = calculateWinnerIndex(totalRotation);
            animateSpin(totalRotation, winnerIdx);
        }   
        
        function startBlinking() {
            let lastTime = 0;
            let show = true;
            function blink(currentTime) {
                if (isSpinning) return;
                if (currentTime - lastTime > 500) {
                    lastTime = currentTime;
                    show = !show;
                    canvas.classList.toggle('blinking', show);
                    drawWheel();
                }
                blinkAnimationId = requestAnimationFrame(blink);
            }
            blinkAnimationId = requestAnimationFrame(blink);
        }

        // --- ë°ì´í„° ì²˜ë¦¬ í•¨ìˆ˜ ---
        function onGeoSuccess(position) {
            lastKnownCoords = { lat: position.coords.latitude, lng: position.coords.longitude };
            statusMessage.textContent = 'ì£¼ë³€ ì‹ë‹¹ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...';
            locationFallback.classList.add('hidden');
            fetchRestaurants(lastKnownCoords.lat, lastKnownCoords.lng, 'geo');
        }

        function onGeoError(error) {
            console.error(error);
            statusMessage.textContent = 'ìœ„ì¹˜ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ì–´ìš”. ì•„ë˜ì—ì„œ ë™ë„¤ë¥¼ ì§ì ‘ ì„ íƒí•´ ì£¼ì„¸ìš”.';
            resetBtn.disabled = false;
            locationFallback.classList.remove('hidden');
        }

        function fetchRestaurants(lat, lng, source = 'geo') {
            const places = new kakao.maps.services.Places();
            places.categorySearch('FD6', (result, status) => {
                if (status === kakao.maps.services.Status.OK) {
                    processRestaurantData(result, '', source);
                } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
                    processRestaurantData([]);
                }
                else {
                    statusMessage.textContent = 'ì£¼ë³€ ì‹ë‹¹ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                    resetBtn.disabled = false;
                }
            }, { location: new kakao.maps.LatLng(lat, lng), radius: 1000, size: 15 });
        }

        function processRestaurantData(data, titlePrefix = '', source = 'geo') {
            if (teamMode) return;
            const mode = modeSelect.value;
            let placesForRoulette = [];
            let listHtml = '';
            
            const createListItem = (place) => {
                if (place.id === 'reroll') {
                    return `<li class="text-gray-500">- ë‹¤ì‹œ í•œ ë²ˆ</li>`;
                }
                const distanceMeters = Number(place.distance || 0);
                const distanceText = distanceMeters > 0 ? `${Math.round(distanceMeters / 10) * 10}m` : 'ê±°ë¦¬ ì •ë³´ ì—†ìŒ';
                const category = place.category_name ? place.category_name.split('>').pop().trim() : '';
                const linkContent = place.place_url && place.place_url !== '#'
                    ? `<a href="${place.place_url}" target="_blank" class="hover:underline hover:text-blue-600">${safeText(place.place_name)}</a>`
                    : safeText(place.place_name);

                return `<li class="bg-slate-50 rounded-md px-3 py-2 shadow-sm" title="${safeText(place.place_name)}">
                            <div class="flex items-center justify-between text-sm font-semibold text-gray-700">
                                <span class="truncate">${linkContent}</span>
                                <span class="text-xs text-gray-500">${safeText(category)}</span>
                            </div>
                            <div class="mt-1 text-xs text-gray-500">${distanceText} Â· ${safeText(place.road_address_name || place.address_name || '')}</div>
                        </li>`;
            };

            if (titlePrefix) {
                placesForRoulette = data;
                listHtml = `<div>
                                <h3 class="text-lg font-semibold text-indigo-700 mb-2 border-b-2 border-indigo-200 pb-1">${safeText(titlePrefix)}</h3>
                                <ul class="space-y-2 text-gray-700">${placesForRoulette.map(p => createListItem(p)).join('')}</ul>
                            </div>`;
            } else {
                switch (mode) {
                    case 'distance': {
                        const distanceSorted = [...data].sort((a, b) => Number(a.distance || Infinity) - Number(b.distance || Infinity));
                        placesForRoulette = distanceSorted;
                        listHtml = `<div>
                                        <h3 class="text-lg font-semibold text-blue-700 mb-2 border-b-2 border-blue-200 pb-1">ğŸš¶â€â™‚ï¸ ê°€ê¹Œìš´ ìˆœ ì¶”ì²œ</h3>
                                        <ul class="space-y-2 text-gray-700">${placesForRoulette.map(p => createListItem(p)).join('')}</ul>
                                    </div>`;
                        break;
                    }
                    case 'random': {
                        const randomPlaces = [...data].sort(() => 0.5 - Math.random());
                        placesForRoulette = randomPlaces;
                        listHtml = `<div>
                                        <h3 class="text-lg font-semibold text-orange-700 mb-2 border-b-2 border-orange-200 pb-1">ğŸ² ëœë¤ ì¶”ì²œ</h3>
                                        <ul class="space-y-2 text-gray-700">${placesForRoulette.map(p => createListItem(p)).join('')}</ul>
                                    </div>`;
                        break;
                    }
                    default: {
                        const distanceSorted = [...data].sort((a, b) => Number(a.distance || Infinity) - Number(b.distance || Infinity));
                        const close = distanceSorted.slice(0, 3);
                        const remainingAfterClose = data.filter(place => !close.find(c => c.id === place.id));
                        const varietyMap = new Map();
                        const variety = [];
                        for (const place of remainingAfterClose) {
                            const category = (place.category_name || '').split('>').pop()?.trim() || 'ê¸°íƒ€';
                            if (!varietyMap.has(category)) {
                                variety.push(place);
                                varietyMap.set(category, true);
                            }
                            if (variety.length >= 3) break;
                        }
                        const leftovers = data.filter(place => !close.includes(place) && !variety.includes(place));
                        const randomPick = [];
                        while (randomPick.length < 3 && leftovers.length > 0) {
                            const randomIndex = Math.floor(Math.random() * leftovers.length);
                            randomPick.push(leftovers.splice(randomIndex, 1)[0]);
                        }
                        placesForRoulette = [...close, ...variety, ...randomPick];
                        listHtml = `<div class="space-y-4">
                                        <div>
                                            <h3 class="text-lg font-semibold text-emerald-700 mb-2 border-b-2 border-emerald-200 pb-1">ğŸ± ê°€ê¹Œìš°ë©´ì„œ ì¸ê¸° ìˆëŠ” ì¡°í•©</h3>
                                            <ul class="space-y-2 text-gray-700">${close.map(p => createListItem(p)).join('')}</ul>
                                        </div>
                                        <div>
                                            <h3 class="text-lg font-semibold text-teal-700 mb-2 border-b-2 border-teal-200 pb-1">ğŸ² ë‹¤ì–‘í•œ ë©”ë‰´</h3>
                                            <ul class="space-y-2 text-gray-700">${variety.map(p => createListItem(p)).join('')}</ul>
                                        </div>
                                        <div>
                                            <h3 class="text-lg font-semibold text-orange-700 mb-2 border-b-2 border-orange-200 pb-1">ğŸ² ê¹œì§ ì„ íƒ</h3>
                                            <ul class="space-y-2 text-gray-700">${randomPick.map(p => createListItem(p)).join('')}</ul>
                                        </div>
                                    </div>`;
                    }
                }
            }
            
            const rerollOption = { place_name: 'ë‹¤ì‹œ í•œ ë²ˆ', id: 'reroll', place_url: '#' };
            while (placesForRoulette.length < SEGMENT_COUNT) {
                placesForRoulette.push(rerollOption);
            }

            restaurants = placesForRoulette.slice(0, SEGMENT_COUNT);
            statusMessage.textContent = source === 'manual' ? 'ì„ íƒí•œ ë™ë„¤ì˜ í›„ë³´ê°€ ì¤€ë¹„ë˜ì—ˆì–´ìš”! STARTë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.' : 'ë£°ë ›ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤! START ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.';
            updateStartButtonState();
            saveContainer.classList.remove('hidden');
            rouletteNameInput.value = '';
            drawWheel();
            candidateListsWrapper.innerHTML = listHtml;
            restaurantListContainer.classList.remove('hidden');
            locationFallback.classList.add('hidden');
        }

        function handleApplyCustomChart() {
            if (teamMode) {
                statusMessage.textContent = 'íŒ€í”Œë ˆì´ ëª¨ë“œì—ì„œëŠ” ì§ì ‘ ë§Œë“  ë£°ë ›ì„ ì ìš©í•  ìˆ˜ ì—†ì–´ìš”. ë¨¼ì € íŒ€ì—ì„œ ë‚˜ê°€ì£¼ì„¸ìš”.';
                return;
            }
            const inputs = document.querySelectorAll('.custom-input');
            const customNames = Array.from(inputs).map(input => input.value.trim()).filter(name => name !== '');

            if (customNames.length === 0) {
                statusMessage.textContent = "ì‹ë‹¹ ì´ë¦„ì„ í•˜ë‚˜ ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.";
                return;
            }

            const customRestaurants = customNames.map((name, index) => ({
                place_name: safeText(name),
                id: `custom_${Date.now()}_${index}`,
                place_url: '#'
            }));
            
            resetState();
            processRestaurantData(customRestaurants, 'ì§ì ‘ ë§Œë“  ë£°ë ›');
            statusMessage.textContent = 'ì§ì ‘ ë§Œë“  ë£°ë ›ì„ ì ìš©í–ˆìŠµë‹ˆë‹¤!';
            updateStartButtonState();
        }

        function applyTemplate(type) {
            const templates = {
                korean: ['ëœì¥ì°Œê°œ', 'ê¹€ì¹˜ì°Œê°œ', 'ë¶ˆê³ ê¸° ë°±ë°˜', 'ëƒ‰ë©´', 'ì œìœ¡ë³¶ìŒ', 'ì¹¼êµ­ìˆ˜', 'ëˆê¹ŒìŠ¤', 'ê³°íƒ•', 'ë¹„ë¹”ë°¥'],
                noodle: ['ì§œì¥ë©´', 'ì§¬ë½•', 'ìš°ë™', 'íŒŒìŠ¤íƒ€', 'ë¼ë©˜', 'ë§‰êµ­ìˆ˜', 'ìŒ€êµ­ìˆ˜', 'ì¹¼êµ­ìˆ˜', 'ì†Œë°”'],
                office: ['ìƒëŸ¬ë“œ', 'ìƒŒë“œìœ„ì¹˜', 'í¬ì¼€', 'ê¹€ë°¥', 'ë®ë°¥', 'ì»µë°¥', 'ë¼ì´ìŠ¤ë²„ê±°', 'íŒŒìŠ¤íƒ€', 'íƒ€ì½”'],
                snack: ['ë–¡ë³¶ì´', 'ìˆœëŒ€', 'íŠ€ê¹€ ëª¨ë‘ ', 'ê¹€ë°¥', 'ì–´ë¬µ', 'ë¼ë³¶ì´', 'ì°ë§Œë‘', 'í•«ë„ê·¸', 'íŠ€ê¹€ìš°ë™']
            };
            const selected = templates[type] || [];
            const inputs = document.querySelectorAll('.custom-input');
            inputs.forEach((input, index) => {
                input.value = selected[index] || '';
            });
        }

        // --- Firebase Firestore í•¨ìˆ˜ ---
        async function handleSave() {
            if (saveBtn.dataset.loading === 'true') return;
            saveBtn.dataset.loading = 'true';
            saveBtn.disabled = true;
            saveBtn.classList.add('opacity-60', 'cursor-not-allowed');
            const finishSave = () => {
                saveBtn.disabled = false;
                saveBtn.classList.remove('opacity-60', 'cursor-not-allowed');
                delete saveBtn.dataset.loading;
            };
            if (teamMode) {
                statusMessage.textContent = 'íŒ€í”Œë ˆì´ ë£°ë ›ì€ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                finishSave();
                return;
            }
            const name = rouletteNameInput.value.trim();
            if (!name) {
                statusMessage.textContent = "ë£°ë › ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.";
                finishSave();
                return;
            }
            if (restaurants.some(r => r.id === 'reroll')) {
                statusMessage.textContent = "'ë‹¤ì‹œ í•œ ë²ˆ'ì´ í¬í•¨ëœ ë£°ë ›ì€ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                finishSave();
                return;
            }

            // ì§ì ‘ ë§Œë“  ë£°ë › ì €ì¥ ì‹œì—ëŠ” ì§€ì—­ëª… ìë™ ì¶”ê°€ ê¸°ëŠ¥ ë¹„í™œì„±í™”
            if (restaurants.every(r => r.id.startsWith('custom'))) {
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    await addDoc(collection(db, "artifacts", appId, "users", userId, "roulettes"), {
                        name: name, // ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì´ë¦„ ê·¸ëŒ€ë¡œ ì €ì¥
                        restaurants: restaurants,
                        createdAt: serverTimestamp()
                    });
                    statusMessage.textContent = `'${name}' ë£°ë ›ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                    rouletteNameInput.value = '';
                    saveContainer.classList.add('hidden');
                } catch (error) {
                    console.error("ë£°ë › ì €ì¥ ì‹¤íŒ¨:", error);
                    statusMessage.textContent = "ë£°ë › ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                }
                finishSave();
                return;
            }

            // ìœ„ì¹˜ ê¸°ë°˜ ë£°ë › ì €ì¥ (ê¸°ì¡´ ë¡œì§)
            if (!userId || !lastKnownCoords) {
                statusMessage.textContent = "ìœ„ì¹˜ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤.";
                finishSave();
                return;
            }
            const geocoder = new kakao.maps.services.Geocoder();
            geocoder.coord2RegionCode(lastKnownCoords.lng, lastKnownCoords.lat, async (result, status) => {
                let regionName = "ì•Œìˆ˜ì—†ìŒ";
                if (status === kakao.maps.services.Status.OK) {
                    const region = result.find(r => r.region_type === 'H');
                    if(region) regionName = region.address_name.split(' ').pop();
                }
                
                const finalName = `[${regionName}] ${name}`;
                
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    await addDoc(collection(db, "artifacts", appId, "users", userId, "roulettes"), {
                        name: finalName,
                        restaurants: restaurants,
                        createdAt: serverTimestamp()
                    });
                    statusMessage.textContent = `'${finalName}' ë£°ë ›ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                    rouletteNameInput.value = '';
                    saveContainer.classList.add('hidden');
                } catch (error) {
                    console.error("ë£°ë › ì €ì¥ ì‹¤íŒ¨:", error);
                    statusMessage.textContent = "ë£°ë › ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                }
                finishSave();
            });
        }

        function loadSavedRoulettes() {
            if (!userId) return;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const q = query(collection(db, "artifacts", appId, "users", userId, "roulettes"), orderBy("createdAt", "desc"));

            onSnapshot(q, (snapshot) => {
                savedRoulettesList.innerHTML = snapshot.empty ? '<p class="text-center text-gray-500">ì €ì¥ëœ ë£°ë ›ì´ ì—†ìŠµë‹ˆë‹¤.</p>' : '';
                snapshot.forEach((doc) => {
                    const roulette = doc.data();
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center p-2 border-b';
                    div.innerHTML = `
                        <span class="font-semibold truncate" title="${safeText(roulette.name)}">${safeText(roulette.name)}</span>
                        <div class="flex-shrink-0 space-x-1">
                            <button data-id="${doc.id}" class="load-btn bg-green-100 text-green-800 text-xs font-semibold px-2 py-1 rounded">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                            <button data-id="${doc.id}" class="share-btn bg-yellow-100 text-yellow-800 text-xs font-semibold px-2 py-1 rounded">ìë‘í•˜ê¸°</button>
                            <button data-id="${doc.id}" class="delete-btn bg-red-100 text-red-800 text-xs font-semibold px-2 py-1 rounded">ì‚­ì œ</button>
                        </div>
                    `;
                    savedRoulettesList.appendChild(div);
                });

                document.querySelectorAll('.load-btn').forEach(btn => btn.addEventListener('click', (e) => loadSpecificRoulette(e.target.dataset.id, 'private')));
                document.querySelectorAll('.share-btn').forEach(btn => btn.addEventListener('click', (e) => handleShare(e.target.dataset.id)));
                document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => deleteSpecificRoulette(e.target.dataset.id)));
            });
        }

        async function loadSpecificRoulette(docId, type) {
            if (!userId) return;
            if (teamMode) {
                statusMessage.textContent = 'íŒ€í”Œë ˆì´ ëª¨ë“œì—ì„œëŠ” ê°œì¸ì´ë‚˜ ê³µê°œ ë£°ë ›ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ì–´ìš”. ë¨¼ì € íŒ€ì—ì„œ ë‚˜ê°€ì£¼ì„¸ìš”.';
                return;
            }
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const collectionPath = type === 'private'
                    ? ["artifacts", appId, "users", userId, "roulettes"] 
                    : ["artifacts", appId, "public", "data", "shared-roulettes"];
                
                const docRef = doc(db, ...collectionPath, docId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const rouletteData = docSnap.data();
                    resetState();
                    restaurants = rouletteData.restaurants;
                    statusMessage.textContent = `'${rouletteData.name}' ë£°ë ›ì„ ì ìš©í–ˆìŠµë‹ˆë‹¤.`;
                    processRestaurantData(restaurants, rouletteData.name);
                    drawWheel();
                    updateStartButtonState();
                }
            } catch (error) {
                console.error("ë£°ë › ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
            }
        }
        
        async function deleteSpecificRoulette(docId) {
            if (!userId) return;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            await deleteDoc(doc(db, "artifacts", appId, "users", userId, "roulettes", docId));
        }

        async function handleShare(docId) {
            if (!userId) return;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const docRef = doc(db, "artifacts", appId, "users", userId, "roulettes", docId);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const rouletteToShare = docSnap.data();
                await addDoc(collection(db, "artifacts", appId, "public", "data", "shared-roulettes"), {
                    ...rouletteToShare,
                    sharedBy: userId,
                    sharedAt: serverTimestamp(),
                    likes: 0,
                    dislikes: 0,
                    voters: []
                });
                statusMessage.textContent = `'${rouletteToShare.name}' ë£°ë ›ì„ ìë‘í–ˆìŠµë‹ˆë‹¤!`;
            }
        }

        function loadSharedRoulettes() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const q = query(collection(db, "artifacts", appId, "public", "data", "shared-roulettes"));
            
            onSnapshot(q, (snapshot) => {
                let roulettes = [];
                snapshot.forEach(doc => {
                    const shared = doc.data();
                    roulettes.push({ id: doc.id, ...shared });
                });

                roulettes.sort((a, b) => {
                    const likesDiff = (b.likes || 0) - (a.likes || 0);
                    if (likesDiff !== 0) return likesDiff;
                    const dateB = b.sharedAt?.toDate() || 0;
                    const dateA = a.sharedAt?.toDate() || 0;
                    return dateB - dateA;
                });

                allSharedRoulettes = roulettes;
                renderSharedRoulettes();
            });
        }

        function renderSharedRoulettes() {
            const searchTerm = searchSharedInput.value.toLowerCase();
            const filteredList = allSharedRoulettes.filter(shared => shared.name?.toLowerCase().includes(searchTerm));

            sharedRoulettesList.innerHTML = filteredList.length === 0 ? '<p class="text-center text-gray-500">ì¼ì¹˜í•˜ëŠ” ë£°ë ›ì´ ì—†ì–´ìš”.</p>' : '';
            
            filteredList.forEach(shared => {
                const div = document.createElement('div');
                div.className = 'p-3 mb-3 border border-slate-200 rounded-lg shadow-sm bg-white';
                const restaurants = Array.isArray(shared.restaurants) ? shared.restaurants : [];
                div.innerHTML = `
                    <p class="font-bold truncate" title="${safeText(shared.name)}">${safeText(shared.name)}</p>
                    <ul class="text-sm text-gray-600 mt-2 grid grid-cols-3 gap-2">
                        ${restaurants.slice(0,3).map(r => `<li class="truncate bg-slate-100 px-2 py-1 rounded text-xs">${safeText(r.place_name)}</li>`).join('')}
                        ${restaurants.length > 3 ? '<li class="text-gray-400 col-span-3 text-xs">... ë“± ë‹¤ì–‘í•œ ì‹ë‹¹ì´ ìˆì–´ìš”</li>' : ''}
                    </ul>
                    <div class="flex items-center justify-between mt-3">
                        <div class="flex items-center space-x-2">
                            <button data-id="${shared.id}" data-vote="like" class="vote-btn flex items-center bg-blue-50 px-3 py-1 rounded-full text-xs hover:bg-blue-100">ğŸ‘ <span class="ml-1 font-semibold">${shared.likes || 0}</span></button>
                            <button data-id="${shared.id}" data-vote="dislike" class="vote-btn flex items-center bg-rose-50 px-3 py-1 rounded-full text-xs hover:bg-rose-100">ğŸ‘ <span class="ml-1 font-semibold">${shared.dislikes || 0}</span></button>
                        </div>
                        <button data-id="${shared.id}" class="apply-btn bg-indigo-500 hover:bg-indigo-600 text-white text-sm font-bold py-1 px-3 rounded">ì ìš©í•˜ê¸°</button>
                    </div>
                `;
                sharedRoulettesList.appendChild(div);
            });

            document.querySelectorAll('.apply-btn').forEach(btn => btn.addEventListener('click', (e) => loadSpecificRoulette(e.target.dataset.id, 'public')));
            document.querySelectorAll('.vote-btn').forEach(btn => btn.addEventListener('click', (e) => handleVote(e.currentTarget.dataset.id, e.currentTarget.dataset.vote)));
        }

        async function handleVote(docId, voteType) {
            if (!userId) return;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const docRef = doc(db, "artifacts", appId, "public", "data", "shared-roulettes", docId);
            
            const docSnap = await getDoc(docRef);
            if (!docSnap.exists()) return;

            const localVotesRaw = localStorage.getItem('lunch-votes') || '{}';
            const localVotes = JSON.parse(localVotesRaw);
            if (localVotes[docId]) {
                statusMessage.textContent = 'ì´ë¯¸ íˆ¬í‘œí•˜ì…¨ìŠµë‹ˆë‹¤.';
                return;
            }

            const voters = docSnap.data().voters || [];
            if (voters.includes(userId)) {
                statusMessage.textContent = 'ì´ë¯¸ íˆ¬í‘œí•˜ì…¨ìŠµë‹ˆë‹¤.';
                localVotes[docId] = true;
                localStorage.setItem('lunch-votes', JSON.stringify(localVotes));
                return;
            }

            const updateData = {
                voters: arrayUnion(userId)
            };
            if (voteType === 'like') {
                updateData.likes = increment(1);
            } else {
                updateData.dislikes = increment(1);
            }
            await updateDoc(docRef, updateData);
            localVotes[docId] = true;
            localStorage.setItem('lunch-votes', JSON.stringify(localVotes));
            statusMessage.textContent = voteType === 'like' ? 'ì¢‹ì•„ìš” ê°ì‚¬í•©ë‹ˆë‹¤!' : 'ì˜ê²¬ì„ ë‚¨ê²¨ì£¼ì…”ì„œ ê°ì‚¬í•´ìš”.';
        }

        function populateWinnerCard(winner) {
            const displayName = winner.isTeamEntry ? (winner.rawText || winner.place_name) : winner.place_name;
            winnerName.textContent = displayName;
            winnerCallBtn.classList.remove('hidden');
            winnerMapBtn.classList.remove('opacity-60', 'pointer-events-none');

            if (winner.isTeamEntry) {
                winnerAddress.innerHTML = `<span class="font-semibold text-gray-700">âœï¸</span> íŒ€ì—ì„œ ì§ì ‘ ì ì€ ë©”ë‰´ì˜ˆìš”.`;
                winnerPhone.innerHTML = `<span class="font-semibold text-gray-700">ğŸ“</span> ì—°ë½ì²˜ ì •ë³´ê°€ ì—†ì–´ìš”.`;
                winnerCallBtn.href = '#';
                winnerCallBtn.classList.add('hidden');
                winnerMapBtn.href = '#';
                winnerMapBtn.classList.add('opacity-60', 'pointer-events-none');
                winnerTip.innerHTML = `<span class="font-semibold text-gray-700">ğŸ’¡</span> íŒ€ì›ë“¤ê³¼ ë§›ì§‘ ì •ë³´ë¥¼ ê³µìœ í•´ë³´ì„¸ìš”!`;
                winnerTag.textContent = 'íŒ€ ì¶”ì²œ';
                return;
            }

            winnerAddress.innerHTML = `<span class="font-semibold text-gray-700">ğŸ“</span> ${safeText(winner.road_address_name || winner.address_name || 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ')}`;
            const phone = winner.phone || '';
            if (phone) {
                winnerPhone.innerHTML = `<span class="font-semibold text-gray-700">ğŸ“</span> ${safeText(phone)}`;
                winnerCallBtn.href = `tel:${phone.replace(/[^0-9+]/g, '')}`;
            } else {
                winnerPhone.innerHTML = `<span class="font-semibold text-gray-700">ğŸ“</span> ì „í™” ì •ë³´ê°€ ì—†ì–´ìš”.`;
                winnerCallBtn.href = '#';
                winnerCallBtn.classList.add('hidden');
            }
            if (winner.place_url) {
                winnerMapBtn.href = winner.place_url;
            } else {
                winnerMapBtn.href = '#';
                winnerMapBtn.classList.add('opacity-60', 'pointer-events-none');
            }
            winnerTip.innerHTML = `<span class="font-semibold text-gray-700">â°</span> ì˜ì—…ì‹œê°„ ì •ë³´ëŠ” ì¹´ì¹´ì˜¤ í˜ì´ì§€ì—ì„œ í™•ì¸í•´ì£¼ì„¸ìš”.`;
            winnerTag.textContent = modeSelect.value === 'random' ? 'ì™„ì „ ëœë¤!' : (modeSelect.value === 'distance' ? 'ê°€ê¹Œìš´ í–‰ìš´' : 'ì¶”ì²œ í”½');
        }
    </script>
</body>
</html>
